# caching

## Гибридный многоуровневый кэш

Композитное приложение на ASP.NET Blazor, которое состоит из нескольких приложений, в котором реализован механизм кэширования в рамках каждого из приложений.

Для композитного приложения такого типа система кэширования данных в рантайме может значительно повысить скорость загрузки и уменьшить нагрузку на базу данных.

Кэширование должно быть многоуровневым, причем каждый уровень кэширования оптимизирован для конкретных потребностей приложения. Например, можно использовать встроенный в ASP.NET Blazor механизм кэширования для хранения часто используемых данных, таких как данные о клиентах или уведомления. Для более объемных данных можно использовать распределенный кэш, такой как Redis или memcached.

### Модули системы кэширования

- Кэширование первого уровня (встроенное в Blazor)
- Кэширование второго уровня (распределенный кэш)
- Централизованный менеджер кэша (для управления несколькими кэшами)

Предполагается, что на уровне каждого приложения кэш будет делиться на две части: 
- общий кэш: хранятся общие данные, полученные из БД (например, таблицы `Commands`, `CommandReceivers` и `CommandExtraData`).
- кэш, зависящий от пользователя: к таким данным могут относиться действия пользователя (напирмер, сохранение клиентов в качестве `CommandReceivers` на одной форме и отображение полного списка `CommandReceivers` на второй форме).

Также для предотвращения переполнения памяти планируется реализовать cache manager:
- Работает по таймеру.
- Просматривает все объекты в кэше и удаляет те объекты, у которых время последнего изменения/доступа бло достаточно давно. 
- Время последнего изменения/доступа логируется следующим образом: любые действия пользователя логируются в объект пользователя, а действия по общим объектам - например, для каждого объекта из таблицы `Commands`, `CommandReceivers` и `CommandExtraData`. Соответственно, при изменении кэшируемых данных или доступе к ним, неактуальные данные удаляются, новые данные достаются из БД, и для объекта обновляется время доступа.

Соответственно, на уровне композитного приложения кэш также имеет ещё один слой сверху: для переключения между различными приложениями.

#### Модули кэширования первого уровня (встроенное в Blazor)

- MemoryCache (основной механизм кэширования в Blazor)
- IDistributedCache (для кэширования данных между серверами)

#### Модули кэширования второго уровня (на уровне каждого приложения)

- RedisCache (для кэширования больших объемов данных)
- MemcachedCache (альтернативный распределенный кэш)
- FileSystemCache (для кэширования статических файлов)

#### Модули централизованного менеджера кэша

- Менеджер подключений кэша (управление несколькими подключениями кэша)
- Политика кэширования (управление временем жизни и политиками очистки кэша)
- Мониторинг кэша (отслеживание использования кэша и выявление проблем)

### Коммуникация между модулями кэширования

#### Данные отсутствуют в кэше, получаем данные в первый раз.

1. Приложение отправляет запрос к централизованному менеджеру кэша.
2. Менеджер кэша проверяет кэши первого и второго уровней.
3. Если данные отсутствуют, менеджер кэша получает данные из базы данных.
4. Менеджер кэша сохраняет данные в кэши первого и второго уровней.
5. Менеджер кэша возвращает данные приложению.

#### Данные отсутствуют в кэше, ранее данные были в кэше, но были удалены как неиспользуемые.

Коммуникация будет такой же, как и в случае первого получения данных.

#### Данные присутствуют в кэше, но они устаревшие.

1. Приложение отправляет запрос к централизованному менеджеру кэша.
2. Менеджер кэша проверяет кэши первого и второго уровней.
3. Если данные устарели, менеджер кэша получает новые данные из базы данных.
4. Менеджер кэша сохраняет новые данные в кэши первого и второго уровней.
5. Менеджер кэша возвращает новые данные приложению.

#### Данные присутствуют в кэше, и они не являются устаревшими.

1. Приложение отправляет запрос к централизованному менеджеру кэша.
2. Менеджер кэша проверяет кэши первого и второго уровней.
3. Если данные присутствуют и не устарели, менеджер кэша возвращает их приложению.

### Очистка кэша

Интервал очистки кэша следует настраивать индивидуально для каждого приложения в зависимости от характера его данных и требований к актуальности. Однако в качестве общего правила можно использовать следующие стратегии:

- **Очистка по времени**: Удалять элементы из кэша по истечении определенного периода времени.
- **Очистка по событию**: Очищать кэш при возникновении определенных событий, таких как создание нового ресурса или обновление существующего.
- **Очистка по зависимостям**: Очищать кэш, когда изменяются данные, от которых зависят закэшированные элементы.

При очистке кэша по событию или зависимостям лучше всего очистить закэшированные данные и затем получить их из базы данных, чтобы обеспечить согласованность с источником данных.

Можно использовать следующие стратегии очистки кэша:

- Очистка по ключу: Удалить из кэша конкретные элементы по их ключам.
- Очистка по тегу: Удалить из кэша все элементы, помеченные определенным тегом.
- Очистка по шаблону: Удалить из кэша все элементы, соответствующие определенному шаблону.

### Улучшения

1. Использование предметно-ориентированного кэша: Кэширование данных на основе сущностей, а не отдельных ключей.
2. Инвалидация данных по зависимостям: Автоматическое удаление кэшированных данных, когда зависящие от них данные обновляются.
3. Стратегии сброса кэша: Реализация различных стратегий сброса кэша, таких как LRU, LFU и TTL.
4. Сериализация данных: Кэширование сериализованных объектов для повышения производительности и уменьшения размера кэша.
5. Асинхронный кэш: Поддержка асинхронных операций для улучшения отклика.
6. Отслеживание использования кэша: Отслеживание частоты использования кэшированных данных для оптимизации производительности и предотвращения утечек кэша.
7. Интеграция с другими сервисами: Интеграция кэша с другими сервисами, такими как очереди сообщений, для обработки обновлений и инвалидаций.
8. Поддержка иерархического кэширования: Разрешение кэширования данных на нескольких уровнях.
9. Настраиваемые стратегии кэширования: Поддержка различных стратегий кэширования для разных типов данных.
10. Конфигурируемость: Предоставление возможности конфигурации параметров кэша, таких как время жизни и максимальный размер.
11. Уведомления о событиях и логирование: Обеспечение механизмов уведомления и логирования о событиях, таких как кэширование и удаление объектов кэша.

### Объектная модель

**Общий кэш:**
- Class: `CommonCache`
- Проперти:
    - `Dictionary<string, object> Data`
    - `DateTime LastUpdated`

**Кэш, зависящий от пользователя:**
- Class: `UserCache`
- Проперти:
    - `Dictionary<int, Dictionary<string, object>> Data`
    - `Dictionary<int, DateTime> LastUpdated`

**Cache Manager:**
- Class: `CacheManager`
- Проперти:
    - `List<CommonCache> CommonCaches`
    - `List<UserCache> UserCaches`
    - `TimeSpan CacheExpiry`
- Методы:
    - `Start()`
    - `RemoveStaleCacheEntries()`
