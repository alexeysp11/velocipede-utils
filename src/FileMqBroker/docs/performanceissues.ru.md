# performanceissues

[English](performanceissues.md) | [Русский](performanceissues.ru.md)

## Проблемы с производительностью при нагрузочном тестировании

Для нагрузочного тестирования используются два приложения:
- [генерация нагрузки](../loadtesting/README.ru.md): работает достаточно стабильно.
- [бэкенд-сервис](../backendservice/README.ru.md): обнаружились проблемы с производительностью (приложение долго обрабатывает запросы и периодически останавливается).

Возможные причины проблем с производительностью на бэкенд-сервисе:
- Некорректная работа с очередью:
    - Для наивной имплементации нет проверки, что файл уже находится в очереди на обработку (т.е. файл будет добавляться в очередь из БД до тех пор, пока его статус не станет `Processed`). См. файл: [ReadMqDispatcher.cs](../mqlibrary/src/QueueDispatchers/ReadMqDispatcher.cs).
    - Нет фильтра в запросе к БД, чтобы исключать из выборки файлы, которые уже есть в очереди.
- Излишняя аллокация объектов в управляемой куче:
    - Можно сделать [MessageFile](../mqlibrary/src/Models/MessageFile.cs) значимым типом, а не ссылочным (для уменьшения затрат на вызов сборщика мусора). Однако это требует внимательного тестирования.
    - Использование `char[]` вместо `string` для полей структуры может уменьшить затраты на аллокацию памяти в управляемой куче, так как массивы символов (`char[]`) являются значимыми типами данных. Однако, необходимо помнить о безопасности и управлении памятью при работе с массивами символов.
    - В приложении часто формируются запросы к БД с помощью `StringBuilder`. Можно создать пул объектов `StringBuilder`, предварительно определив количество объектов, соответствующее максимальной нагрузке. При этом важно обеспечить правильное управление доступом к объектам в пуле, чтобы избежать гонок данных и других проблем с многопоточностью.
- Ограничения из-за обязательной записи статуса сообщения в БД:
    - На стороне бэкенд-сервиса не предусмотрена ситуация, когда файл записан в директорию, но не записан в БД (соответственно, из-за этого в директории файлы могут накапливаться и не удаляться своевременно). Можно написать бэкграунд-задачу, которая добавляет в таблицу `RequestMessageFiles` файлы, которые находятся в директории давно.
