# PublicTransportDevices

[English](README.md) | [Русский](README.ru.md)

Этот проект включает в себя разработку архитектуры системы аналитики в реальном времени для обработки большого объема данных устройств и реализацию прототипа серверного приложения на C# для сбора и обработки данных.

## Общее описание

### Цель

Цель проекта — разработать архитектуру и прототип системы аналитики в реальном времени для сбора и обработки данных с 20 тысяч устройств каждую секунду с упором на данные датчиков и геолокации.

### Объем

В объем проекта входит предложение сервисной архитектуры для системы аналитики, реализация прототипа серверного приложения на C# для сбора и обработки данных, а также рассмотрение таких аспектов, как регистрация устройств, обработка событий и протоколы связи.

### Кто может использовать этот проект

Этот проект может использоваться компаниями или организациями, которым необходимо собирать, обрабатывать и отображать данные в реальном времени с большого количества устройств, например, в сфере Интернета вещей или управления автопарком.

### Возможные ограничения

Возможные ограничения этого проекта могут включать проблемы масштабируемости при работе с большим количеством устройств, потенциальные узкие места в производительности при обработке данных в реальном времени и необходимость надежных мер безопасности для защиты конфиденциальной информации об устройствах.

## Технические требования 

1. Разработать архитектуру системы аналитики реального времени. 
Вводные данные: 
    - Данные собираются с 20 тысяч устройств ежесекундно; 
    - Тип собираемых данных: параметры работы датчиков и устройств, геопозиция; 
    - Данные используются для последующего отображения на дашбордах. 

Предложить архитектуру сервиса: из каких компонентов он должен состоять? 
Почему выбраны те или иные решения? 
Какие технологии используются и почему? 

2. Реализовать прототип системы аналитики на языке C#. 
Прототип представляет из себя серверное приложение. 
Данное приложение требуется, в первую очередь, для сбора данных с устройств, установленных на транспортных средствах. 

Сервер принимает от клиента запросы и обрабатывает их: 
- Регистрация устройства с занесением его в базу данных; 
- Регистрация нового события для конкретного устройства с занесением его в базу данных; 
- Обработка запроса списка событий. 

Событием можно считать JSON, полученный сервисом который содержит пары ключ-значение, где значение - типы данных `int`, `float` и `str`. 
Каким образом будет реализована связь между устройствами и системой сбора эвентов, а также: будете ли вы реализовывать авторизацию устройства, очередь для хранения потока событий или будете иным образом выбирать события от данного устройства - тоже выбор за вами. 

## Архитектура 

В текущей реализации приложения используемуются следующие технологии:

- WebAPI; 
- База данных: PostgreSQL; 
- Брокер сообщений: RabbitMQ. 

![MessageQueueArchitecture](docs/img/MessageQueueArchitecture.png)

Объяснение, почему выбран данный тип архитектуры, и какие могут быть альтернативы данном подходу, можно прочитать по [ссылке](docs/architecture.ru.md). 

## Реализация 

Имеется два контроллера, у каждого из которых есть GET и POST методы: 
- GET-метод возвращает объект типа `System.Data.DataTable` (сделано из соображения, что клиентское приложение также может отображать данные в табличном виде); 
- POST-метод не возвращает никакого параметра. 

### Как запускать 

1. Настройка базы данных 

В качестве базы данных используется PostgreSQL.

Специфизировать ConnectionString можно в `appsettings.json`:

```JSON
"AppSettings": {
    "PostgresConnectionString": "Server=127.0.0.1;Port=5432;Userid=postgres;Password=postgres;Database=postgres"
}
```

В папке `init` находятся файлы со скриптами для того, чтобы настроить базу данных (`initpg.sql` - для инициализации таблиц). 

2. Настройка брокера сообщений 

В качестве брокера сообщений используется RabbitMQ: 

- Exchange name: `ptd_exchange`; 
- Queue name: `ptd_queue`. 

### Регистрация устройства с занесением его в базу данных

Регистрация устройства на C#: 

```C#
var httpClient = new HttpClient(); 
var url = "https://localhost:7010/RegisterDevice"; 
var device = new Device 
    {
        Uid = "3eb20d9f-3350-4bd3-b343-d903d2e51cfb", 
        DeviceType = DeviceType.DriverConsole
    };
await httpClient.PostAsJsonAsync(url, device); 
```

Регистрация устройства с помощью JSON (Request URL: `https://localhost:7010/RegisterDevice`): 

```JSON
{
  "uid": "3eb20d9f-3350-4bd3-b343-d903d2e51cfb",
  "deviceType": 2
}
```

### Регистрация нового события для конкретного устройства с занесением его в базу данных

По [данной ссылке](docs/insertptdi.ru.md) представлена информация о том, как производится регистрация нового события для конкретного устройства с занесением его в базу данных. 
